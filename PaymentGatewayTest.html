<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway Redirect Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .info {
            background: #e7f3fe;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 300px;
        }
        #paymentForm {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üè¶ Payment Gateway Redirect Test</h1>
    
    <div class="section">
        <h2>Step 1: Create Test Order</h2>
        <input type="text" id="orderId" placeholder="Order ID" value="TEST-20251113-999">
        <input type="number" id="amount" placeholder="Amount" value="0.1" step="0.01">
        <button onclick="initiatePayment()">Initiate Payment</button>
    </div>

    <div class="section">
        <h2>Step 2: Payment Gateway Response</h2>
        <div id="response"></div>
    </div>

    <div class="section">
        <h2>Step 3: Redirect to Gateway</h2>
        <div id="redirectInfo"></div>
        <button id="redirectBtn" onclick="redirectToGateway()" style="display:none;">Go to Payment Gateway</button>
    </div>

    <!-- Hidden form for POST redirect -->
    <form id="paymentForm" method="POST" action="">
        <input type="hidden" name="encRequest" id="encRequest" value="">
        <input type="hidden" name="access_code" id="accessCode" value="">
    </form>

    <script>
        const API_BASE = 'https://spirithubapi.sbc.om/api';
        let gatewayData = null;

        async function initiatePayment() {
            const orderId = document.getElementById('orderId').value;
            const amount = parseFloat(document.getElementById('amount').value);

            const responseDiv = document.getElementById('response');
            responseDiv.innerHTML = '<p>‚è≥ Initiating payment...</p>';

            try {
                const response = await fetch(`${API_BASE}/payment/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: amount,
                        currency: 'OMR',
                        customerName: 'Test Customer',
                        customerEmail: 'test@example.com',
                        customerPhone: '+96812345678'
                    })
                });

                const data = await response.json();
                gatewayData = data;

                if (data.success) {
                    responseDiv.innerHTML = `
                        <div class="info">
                            <p>‚úÖ Payment initiated successfully!</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;

                    // Show redirect info
                    document.getElementById('redirectInfo').innerHTML = `
                        <div class="info">
                            <p><strong>Payment URL:</strong> ${data.paymentUrl}</p>
                            <p><strong>Access Code:</strong> ${data.accessCode}</p>
                            <p><strong>Encrypted Request Length:</strong> ${data.encryptedRequest?.length || 0} characters</p>
                        </div>
                    `;

                    document.getElementById('redirectBtn').style.display = 'inline-block';
                } else {
                    responseDiv.innerHTML = `
                        <div style="background: #ffebee; padding: 10px; border-left: 4px solid #f44336;">
                            <p>‚ùå Payment initiation failed!</p>
                            <p><strong>Error:</strong> ${data.errorMessage || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = `
                    <div style="background: #ffebee; padding: 10px; border-left: 4px solid #f44336;">
                        <p>‚ùå Network error!</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function redirectToGateway() {
            if (!gatewayData || !gatewayData.success) {
                alert('No valid payment data available');
                return;
            }

            // Method 1: POST form submission (recommended for Bank Muscat)
            const form = document.getElementById('paymentForm');
            form.action = gatewayData.paymentUrl;
            document.getElementById('encRequest').value = gatewayData.encryptedRequest;
            document.getElementById('accessCode').value = gatewayData.accessCode;

            console.log('Redirecting to:', gatewayData.paymentUrl);
            console.log('Access Code:', gatewayData.accessCode);
            console.log('Encrypted Request:', gatewayData.encryptedRequest?.substring(0, 50) + '...');

            // Submit the form
            form.submit();
        }
    </script>
</body>
</html>
